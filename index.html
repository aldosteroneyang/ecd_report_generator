<!DOCTYPE html>
<html>

<head>
  <title>ECD Report Generator</title>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Handsontable CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
  <!-- 引入報告生成相關腳本 -->
  <script type="module" src="report-generator.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .delete-btn {
        background: none;
        border: none;
        color: #ff4444;
        cursor: pointer;
        padding: 8px;
        font-size: 16px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-btn:hover {
        background: #ffeeee;
        border-radius: 4px;
    }

    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header-row {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 10px;
      font-weight: bold;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .input-row {
        display: grid;
        grid-template-columns: auto 3fr 1fr;
        gap: 10px;
        margin-bottom: 5px;
        align-items: center;
    }

    .search-container {
      position: relative;
    }

    .dropdown-item.selected {
        background-color: #e6f3ff;
    }

    .search-input,
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-size: 14px;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }

    .dropdown-item {
      padding: 8px;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    select {
      height: 35px;
      -webkit-appearance: menulist;
      appearance: menulist;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: #5cb85c;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #4cae4c;
    }

    .reminder {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="input-section">
      <div class="header-row">
        <div>Location</div>
        <div>Severity</div>
      </div>
      <div id="hot-container" style="height: 300px; overflow: hidden; margin-bottom: 20px;"></div>
      <div id="input-grid" style="display: none;"></div>
      <div id="atrophy-checkboxes"></div>
    </div>
    <div class="sidebar">
      <button onclick="copyReport('findings')">Copy Findings</button>
      <button onclick="copyReport('impression')">Copy Impression</button>
      <button onclick="copyReport('alz')">Copy Impression (ALZ)</button>
      <button onclick="copyReport('dlb')">Copy Impression (DLB)</button>
      <button onclick="clearTable()">Clear</button>
    </div>
  </div>
  <div id="notification" class="notification"></div>

  <?html>
  <div id="perfusion-table-container" class="w-full p-2">
    <style>
      .perfusion-table {
        width: 100%;
        max-width: 900px; /* Limit maximum width */
        border-collapse: collapse;
        margin-top: 0.75rem;
        font-size: 0.75rem; /* Smaller base font size */
      }
      .perfusion-table th,
      .perfusion-table td {
        border: 1px solid #e5e7eb;
        padding: 0.25rem 0.375rem; /* Reduced padding */
        text-align: center;
      }
      .perfusion-table th {
        background-color: #f3f4f6;
        font-size: 0.75rem; /* Smaller header font */
        white-space: nowrap; /* Prevent header wrapping */
      }
      .perfusion-table td:first-child {
        font-weight: 500;
        background-color: #f9fafb;
        text-align: left;
        font-size: 0.75rem; /* Smaller disease names */
      }
      .toggle-button {
        background-color: #4cae4c;
        border: 1px solid #e5e7eb;
        padding: 0.375rem 0.75rem; /* Smaller button padding */
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem; /* Smaller button text */
        transition: all 0.2s;
      }
      .toggle-button:hover {
        background-color: #f3f4f6;
      }
      .legend {
        margin-top: 0.75rem;
        font-size: 0.75rem; /* Smaller legend text */
      }
      .legend ul {
        list-style-type: disc;
        padding-left: 1.25rem;
        margin-top: 0.375rem;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      #perfusion-table-container {
        margin: 0 auto; /* Center the container */
      }
    </style>

    <div class="header">
      <h2 style="font-size: 1rem; font-weight: 600;">Brain Perfusion Changes in Neurodegenerative Diseases</h2>
      <button id="toggleButton" class="toggle-button">Show Marked Findings Only</button>
    </div>
    <div id="tableContainer"></div>

    <script>
      const data = {
        all: {
          diseases: [
            'Alzheimer\'s Disease (AD)',
            'Dementia with Lewy Bodies (DLB)',
            'Frontotemporal Dementia (FTD)', 
            'Parkinson\'s Disease (PD)',
            'Vascular Parkinsonism (VP)',
            'Cortical Cerebellar Atrophy (CCA)',
            'Multiple System Atrophy-C (MSA-C)',
            'Amyotrophic Lateral Sclerosis (ALS)'
          ],
          regions: [
            'Frontal Cortex',
            'Central Sulcus',
            'Parietal Cortex',
            'Temporal Cortex', 
            'Insula',
            'Occipital Cortex',
            'Precuneus',
            'Post. Cingulate', // Shortened name
            'Cingulate',
            'Basal Ganglia',
            'Thalamus',
            'Cerebellum',
            'Pons'
          ],
          findings: {
            'Alzheimer\'s Disease (AD)': {
              'Parietal Cortex': '↓',
              'Precuneus': '↓↓',
              'Post. Cingulate': '↓↓'
            },
            'Dementia with Lewy Bodies (DLB)': {
              'Frontal Cortex': '↓',
              'Parietal Cortex': '↓',
              'Occipital Cortex': '↓↓',
              'Precuneus': '↓↓',
              'Post. Cingulate': '↓',
              'Cingulate': '↓'
            },
            'Frontotemporal Dementia (FTD)': {
              'Frontal Cortex': '↓*',
              'Temporal Cortex': '↓',
              'Insula': '↓'
            },
            'Parkinson\'s Disease (PD)': {
              'Occipital Cortex': '↓',
              'Precuneus': '↓',
              'Basal Ganglia': '↑↑',
              'Thalamus': '↑↑',
              'Cerebellum': '↑↑'
            },
            'Vascular Parkinsonism (VP)': {
              'Frontal Cortex': '↓',
              'Parietal Cortex': '↓',
              'Temporal Cortex': '↓',
              'Insula': '↓',
              'Cingulate': '↓↓',
              'Basal Ganglia': '↓↓',
              'Thalamus': '↓↓'
            },
            'Cortical Cerebellar Atrophy (CCA)': {
              'Frontal Cortex': '↓?',
              'Cerebellum': '↓'
            },
            'Multiple System Atrophy-C (MSA-C)': {
              'Frontal Cortex': '↓?',
              'Cerebellum': '↓↓',
              'Pons': '↓↓'
            },
            'Amyotrophic Lateral Sclerosis (ALS)': {
              'Frontal Cortex': '↓',
              'Central Sulcus': '↓↓',
              'Parietal Cortex': '↓'
            }
          }
        },
        marked: {
          diseases: [
            'Alzheimer\'s Disease (AD)',
            'Dementia with Lewy Bodies (DLB)',
            'Vascular Parkinsonism (VP)',
            'Parkinson\'s Disease (PD)',
            'Multiple System Atrophy-C (MSA-C)'
          ],
          regions: [
            'Occipital Cortex',
            'Precuneus',
            'Post. Cingulate',
            'Cingulate',
            'Basal Ganglia',
            'Thalamus',
            'Cerebellum',
            'Pons'
          ],
          findings: {
            'Alzheimer\'s Disease (AD)': {
              'Precuneus': '↓↓',
              'Post. Cingulate': '↓↓'
            },
            'Dementia with Lewy Bodies (DLB)': {
              'Occipital Cortex': '↓↓',
              'Precuneus': '↓↓'
            },
            'Vascular Parkinsonism (VP)': {
              'Cingulate': '↓↓',
              'Basal Ganglia': '↓↓',
              'Thalamus': '↓↓'
            },
            'Parkinson\'s Disease (PD)': {
              'Basal Ganglia': '↑↑',
              'Thalamus': '↑↑',
              'Cerebellum': '↑↑'
            },
            'Multiple System Atrophy-C (MSA-C)': {
              'Cerebellum': '↓↓',
              'Pons': '↓↓'
            }
          }
        }
      };

      function renderTable(showMarkedOnly) {
        const currentData = showMarkedOnly ? data.marked : data.all;
        let html = `
          <div style="max-width: 900px; margin: 0 auto; overflow-x: auto;">
            <table class="perfusion-table">
              <thead>
                <tr>
                  <th>Disease / Region</th>
                  ${currentData.regions.map(region => `<th>${region}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${currentData.diseases.map(disease => `
                  <tr>
                    <td>${disease}</td>
                    ${currentData.regions.map(region => `
                      <td>${currentData.findings[disease]?.[region] || '–'}</td>
                    `).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="legend">
            <p style="font-weight: 500;">Legend:</p>
            <ul>
              ${!showMarkedOnly ? `
                <li>↓: Decreased perfusion</li>
                <li>↓?: Questionable decrease</li>
                <li>↓*: Asymmetric decrease</li>
              ` : ''}
              <li>↓↓: Markedly decreased perfusion</li>
              <li>↑↑: Markedly increased perfusion</li>
              <li>–: No ${showMarkedOnly ? 'marked' : 'significant'} change reported</li>
            </ul>
            ${showMarkedOnly ? `
              <p style="margin-top: 0.5rem; color: #666;">
                Note: Only marked changes (↓↓ or ↑↑) are shown. Minor changes are omitted for clarity.
              </p>
            ` : ''}
          </div>
        `;
        document.getElementById('tableContainer').innerHTML = html;
      }

      let showMarkedOnly = false;
      renderTable(showMarkedOnly);

      document.getElementById('toggleButton').addEventListener('click', () => {
        showMarkedOnly = !showMarkedOnly;
        document.getElementById('toggleButton').textContent = 
          showMarkedOnly ? 'Show All Findings' : 'Show Marked Findings Only';
        renderTable(showMarkedOnly);
      });
    </script>
  </div>

  <div style="margin-top: 40px; font-size: 12px;">
    <p><strong>References:</strong></p>
    <ol>
      <li>Waragai M, Yamada T, Matsuda H. <a href="https://pubmed.ncbi.nlm.nih.gov/17493637/" target="_blank">Evaluation of brain perfusion SPECT using an easy Z-score imaging system (eZIS) as an adjunct to early-diagnosis of neurodegenerative diseases.</a> J Neurol Sci. 2007 Sep 15;260(1-2):57-64. doi: 10.1016/j.jns.2007.03.027. Epub 2007 May 9. PMID: 17493637.</li>
      <li>Matsuda H. <a href="https://pubmed.ncbi.nlm.nih.gov/17631544/" target="_blank">Role of neuroimaging in Alzheimer's disease, with emphasis on brain perfusion SPECT.</a> J Nucl Med. 2007 Aug;48(8):1289-300. doi: 10.2967/jnumed.106.037218. Epub 2007 Jul 13. PMID: 17631544.</li>
    </ol>
  </div>


</body>
<script type="module">
  // 導入報告生成函數
  import { 
    collectDataFromRows,
    formatRegions,
    createHypoperfusionText,
    capitalizeFirstLetter,
    pluralizeRegions,
    processReportText,
    generateAtrophyText,
    formatCerebellarDiaschisisText,
    formatText,
    formatNumberedText,
    ensurePeriodEnding,
    generateReports
  } from './report-generator.js';

  // 全局變量
  let hot;
  let locationStatusMap = new Map();
  const SEVERITIES = ['', 'moderate', 'slight', 'mild', 'marked'];
  const LOCATIONS = [];
  const BILATERAL_ONLY_AREAS = [
      "cerebellum", 
      "basal ganglia",
      "thalami"
  ];
  const SIDES = ['left', 'right', 'bilateral'];
  
  // 生成位置組合
  // 基本區域
  const BASE_AREAS = [
      "frontal",
      "temporal",
      "parietal",
      "occipital",
      "cerebellar",
      "basal ganglia",
      "thalamus"
  ];
  
  // 額外區域
  const EXTRA_AREAS = [
      "precuneus",
      "anterior cingulate",
      "posterior cingulate",
      "posterior parietal",
      "posterior temporal",
      "posterior frontal",
      "parietal association cortex",
      "temporal association cortex",
      "frontal association cortex",
      "occipitotemporal",
      "temporoparietal junction"
  ];
  
  // 為每個基本區域添加側面 (除了 BILATERAL_ONLY_AREAS)
  BASE_AREAS.forEach(area => {
      if (BILATERAL_ONLY_AREAS.includes(area)) {
          LOCATIONS.push(area);
      } else {
          SIDES.forEach(side => {
              LOCATIONS.push(`${side} ${area}`);
          });
      }
  });
  
  // 為每個額外區域添加側面
  EXTRA_AREAS.forEach(area => {
      SIDES.forEach(side => {
          LOCATIONS.push(`${side} ${area}`);
      });
  });
  
  // 初始化畫面
  document.addEventListener('DOMContentLoaded', function() {
      initLocationMap();
      initHandsontable();
      renderAtrophyCheckboxes();
      renderCerebellarDiaschisisCheckbox();
  });
  
  // 初始化位置狀態映射
  function initLocationMap() {
      // 為每個位置添加一個空的狀態
      LOCATIONS.forEach(location => {
          locationStatusMap.set(location, '');
      });
  }
  
  // 初始化 Handsontable
  function initHandsontable() {
      const container = document.getElementById('hot-container');
      
      // 自定義單元格渲染器
      function locationRenderer(instance, td, row, col, prop, value, cellProperties) {
          Handsontable.renderers.TextRenderer.apply(this, arguments);
          
          // 如果位置不是空的，添加一個刪除按鈕
          if (value) {
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = '×';
              deleteBtn.className = 'delete-btn';
              deleteBtn.addEventListener('click', () => {
                  instance.setDataAtCell(row, col, '');
                  locationStatusMap.set(value, '');
                  
                  // 更新表格
                  syncTableWithMap();
              });
              
              // 清除單元格內容並添加刪除按鈕
              td.innerHTML = '';
              td.appendChild(document.createTextNode(value));
              td.appendChild(deleteBtn);
          }
      }
      
      // 自定義自動完成編輯器
      class CustomAutocompleteEditor extends Handsontable.editors.TextEditor {
          constructor(hotInstance) {
              super(hotInstance);
              
              // 創建下拉選單
              this.dropdown = document.createElement('div');
              this.dropdown.className = 'custom-autocomplete-dropdown';
              this.dropdown.style.position = 'absolute';
              this.dropdown.style.display = 'none';
              document.body.appendChild(this.dropdown);
              
              // 設置變量
              this.items = [];
              this.selectedItemIndex = -1;
              this.selectedItem = null;
              this.selectedRow = null;
              
              // 監聽輸入事件
              this.TEXTAREA.addEventListener('input', () => {
                  const value = this.TEXTAREA.value.trim();
                  if (value.length > 0) {
                      this.showDropdown();
                  } else {
                      this.hideDropdown();
                  }
              });
              
              // 監聽鍵盤事件
              this.TEXTAREA.addEventListener('keydown', (e) => {
                  if (this.dropdown.style.display === 'none') {
                      return;
                  }
                  
                  switch (e.key) {
                      case 'ArrowDown':
                          e.preventDefault();
                          this.selectNextItem();
                          break;
                      case 'ArrowUp':
                          e.preventDefault();
                          this.selectPrevItem();
                          break;
                      case 'Enter':
                          if (this.selectedItem) {
                              e.preventDefault();
                              this.selectCurrentItem();
                              this.finishEditing();
                          }
                          break;
                      case 'Escape':
                          this.hideDropdown();
                          break;
                  }
              });
              
              // 監聽文檔點擊事件，點擊外部時關閉下拉選單
              document.addEventListener('click', (e) => {
                  if (!this.dropdown.contains(e.target) && e.target !== this.TEXTAREA) {
                      this.hideDropdown();
                  }
              });
          }
          
          prepare(row, col, prop, td, originalValue, cellProperties) {
              super.prepare(row, col, prop, td, originalValue, cellProperties);
          }
          
          beginEditing(initialValue, event) {
              super.beginEditing(initialValue, event);
              
              // 如果有初始值，顯示下拉選單
              const value = this.TEXTAREA.value.trim();
              if (value.length > 0) {
                  this.showDropdown();
              }
          }
          
          finishEditing(restoreOriginalValue, ctrlDown, callback) {
              const value = this.TEXTAREA.value.trim();
              
              // 檢查輸入的位置是否有效
              if (value && !LOCATIONS.includes(value)) {
                  // 設置值並結束編輯
                  this.TEXTAREA.value = value;
                  
                  // 通過 setTimeout 防止事件衝突
                  setTimeout(() => {
                      try {
                          super.finishEditing();
                          
                          // 在編輯完成後，設置默認的嚴重程度
                          const selectedRange = this.hot.getSelectedRange();
                          if (selectedRange && selectedRange.from) {
                              const row = selectedRange.from.row;
                              
                              // 檢查當前行的嚴重程度是否為空
                              const currentSeverity = this.hot.getDataAtCell(row, 1);
                              if (!currentSeverity) {
                                  // 設置默認嚴重程度為 'moderate'
                                  this.hot.setDataAtCell(row, 1, 'moderate');
                              }
                              
                              // 如果這是最後一行，確保添加新行
                              if (row === this.hot.countRows() - 1) {
                                  syncTableWithMap();
                              }
                          }
                      } catch (e) {
                          console.error('Error in finishEditing:', e);
                      }
                  }, 10);
              } else {
                  super.finishEditing();
              }
          }
          
          showDropdown() {
              const query = this.TEXTAREA.value.toLowerCase();
              
              // 使用原版的 fuzzy search 邏輯
              const searchWords = query.split(' ').filter(word => word.length > 0);
              let matches = LOCATIONS;
              
              if (searchWords.length > 0) {
                  matches = LOCATIONS.filter(location => {
                      const locationLower = location.toLowerCase();
                      return searchWords.every(word => locationLower.includes(word));
                  });
              }
              
              // 只過濾具有有效嚴重程度值的位置
              matches = matches.filter(location => {
                  // 排除已有嚴重程度的位置，但要確保嚴重程度不是空字串
                  const severity = locationStatusMap.get(location);
                  return !severity || severity === ''; // 如果沒有值或值為空字串，則保留
              });
              
              if (matches.length === 0) {
                  this.hideDropdown();
                  return;
              }
              
              // 更新下拉選單內容
              this.dropdown.innerHTML = '';
              this.items = matches;
              this.selectedItemIndex = -1;
              this.selectedItem = null;
              
              matches.forEach((match, index) => {
                  const item = document.createElement('div');
                  item.className = 'custom-autocomplete-item';
                  item.textContent = this.formatDisplayLocation(match);
                  item.style.padding = '8px 10px';
                  item.style.cursor = 'pointer';
                  item.style.borderBottom = '1px solid #f0f0f0';
                  item.style.transition = 'background-color 0.15s ease';
                  
                  item.addEventListener('mouseover', () => {
                      this.selectItem(index);
                  });
                  
                  item.addEventListener('click', () => {
                      this.TEXTAREA.value = match;
                      this.selectedItem = match;
                      
                      // 立即設置默認嚴重程度為 'moderate'
                      // 在 finishEditing 之前記錄當前行
                      const selectedRange = this.hot.getSelectedRange();
                      if (selectedRange && selectedRange.from) {
                          this.selectedRow = selectedRange.from.row;
                      }
                      
                      this.finishEditing();
                  });
                  
                  this.dropdown.appendChild(item);
              });
              
              // 計算並設置下拉選單位置
              const rect = this.TEXTAREA.getBoundingClientRect();
              this.dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
              this.dropdown.style.left = (rect.left + window.scrollX) + 'px';
              this.dropdown.style.width = rect.width + 'px';
              this.dropdown.style.maxHeight = '200px';
              this.dropdown.style.overflowY = 'auto';
              this.dropdown.style.backgroundColor = 'white';
              this.dropdown.style.border = '1px solid #ddd';
              this.dropdown.style.borderRadius = '4px';
              this.dropdown.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
              this.dropdown.style.zIndex = '2000';
              this.dropdown.style.display = 'block';
          }
          
          formatDisplayLocation(location) {
              if (location.includes('basal ganglia') && 
                  (location.startsWith('left ') || location.startsWith('right '))) {
                  return location.replace('basal ganglia', 'basal ganglion');
              }
              return location;
          }
          
          selectItem(index) {
              const items = this.dropdown.querySelectorAll('.custom-autocomplete-item');
              items.forEach(item => {
                  item.style.backgroundColor = '';
                  item.style.color = '';
              });
              
              if (index >= 0 && index < items.length) {
                  this.selectedItemIndex = index;
                  this.selectedItem = this.items[index];
                  items[index].style.backgroundColor = '#e6f3ff';
                  items[index].style.color = '#1890ff';
                  items[index].style.fontWeight = '500';
              }
          }
          
          selectNextItem() {
              if (!this.items || this.items.length === 0) {
                  return;
              }
              
              let nextIndex;
              if (this.selectedItemIndex < 0 || this.selectedItemIndex >= this.items.length - 1) {
                  nextIndex = 0; // 循環到第一項
              } else {
                  nextIndex = this.selectedItemIndex + 1;
              }
              
              this.selectItem(nextIndex);
              
              // 確保選中項可見
              const items = this.dropdown.querySelectorAll('.custom-autocomplete-item');
              if (items[nextIndex]) {
                  items[nextIndex].scrollIntoView({ block: 'nearest' });
              }
          }
          
          selectPrevItem() {
              if (!this.items || this.items.length === 0) {
                  return;
              }
              
              let prevIndex;
              if (this.selectedItemIndex <= 0) {
                  prevIndex = this.items.length - 1; // 循環到最後一項
              } else {
                  prevIndex = this.selectedItemIndex - 1;
              }
              
              this.selectItem(prevIndex);
              
              // 確保選中項可見
              const items = this.dropdown.querySelectorAll('.custom-autocomplete-item');
              if (items[prevIndex]) {
                  items[prevIndex].scrollIntoView({ block: 'nearest' });
              }
          }
          
          selectCurrentItem() {
              if (this.selectedItem) {
                  this.TEXTAREA.value = this.selectedItem;
              }
          }
          
          hideDropdown() {
              if (this.dropdown) {
                  this.dropdown.style.display = 'none';
              }
          }
          
          getValue() {
              return this.TEXTAREA.value;
          }
      }
      
      hot = new Handsontable(container, {
          data: data,
          colHeaders: ['Location', 'Severity'],
          columns: [
              {
                  editor: CustomAutocompleteEditor,
                  renderer: locationRenderer
              },
              {
                  type: 'dropdown',
                  source: SEVERITIES
              }
          ],
          colWidths: [280, 100], // 設定 Location 列寬一些，Severity 列窄一些
          minSpareRows: 1,  // 始終保持一個額外的空行
          contextMenu: true,
          licenseKey: 'non-commercial-and-evaluation',
          autoWrapRow: true,
          autoWrapCol: true,
          afterChange: function(changes, source) {
              if (source === 'loadData') return;
              
              if (changes) {
                  changes.forEach(([row, prop, oldValue, newValue]) => {
                      const rowData = hot.getDataAtRow(row);
                      const location = rowData[0];
                      const severity = rowData[1];
                      
                      if (location && severity) {
                          locationStatusMap.set(location, severity);
                          
                          // 如果嚴重程度設定了，自動聚焦到下一個空白行
                          if (row === hot.countRows() - 1) {
                              setTimeout(() => {
                                  syncTableWithMap();
                              }, 10);
                          }
                      } else if (location && !severity && oldValue) {
                          // 如果清除了 severity，也從 map 中移除相應的 severity
                          locationStatusMap.set(location, '');
                      } else if (location && !severity) {
                          // 自動設置默認嚴重程度為 'moderate'
                          hot.setDataAtCell(row, 1, 'moderate');
                      } else if (!location && oldValue && prop === 0) {
                          // 如果清除了 location，則從 map 中移除該項
                          locationStatusMap.set(oldValue, '');
                      }
                  });
              }
              
              syncTableWithMap();
          },
          beforeRemoveRow: function(index, amount) {
              // 刪除行前，將 locationStatusMap 中對應項目的值設為空字串
              for (let i = index; i < index + amount; i++) {
                  const location = hot.getDataAtCell(i, 0);
                  if (location) {
                      // 不完全刪除，而是設為空字串，這樣該位置以後可以再次選擇
                      locationStatusMap.set(location, '');
                  }
              }
          }
      });
      
      // 初始化後觸發一次事件
      document.dispatchEvent(new CustomEvent('locationStatusMapChanged'));
  }
  
  // 將 locationStatusMap 同步到表格
  function syncTableWithMap() {
      const tableData = [];
      
      // 首先添加已有的行
      for (let i = 0; i < hot.countRows(); i++) {
          const location = hot.getDataAtCell(i, 0);
          
          if (location) {
              const severity = locationStatusMap.get(location) || hot.getDataAtCell(i, 1);
              tableData.push([location, severity]);
          }
      }
      
      // 確保至少有一個空行
      if (tableData.length === 0 || (tableData[tableData.length-1][0] !== '' && tableData[tableData.length-1][1] !== '')) {
          tableData.push(['', '']);
      }
      
      hot.loadData(tableData);
      
      // 更新小腦交叉失活狀態
      document.dispatchEvent(new CustomEvent('locationStatusMapChanged'));
  }
  
  // React 組件: 腦萎縮相關選項
  function renderAtrophyCheckboxes() {
      const container = document.getElementById('atrophy-checkboxes');
      
      window.atrophyFindings = {
          fissures: false,
          ventricles: false,
          sulci: false,
          interhemisphericFissures: false
      };
      
      // 創建容器
      const boxDiv = document.createElement('div');
      boxDiv.style.marginTop = '1rem';
      boxDiv.style.padding = '1rem';
      boxDiv.style.border = '1px solid #ddd';
      boxDiv.style.borderRadius = '4px';
      boxDiv.style.backgroundColor = '#f5f5f5';
      
      // 標題
      const title = document.createElement('h3');
      title.textContent = 'Atrophy Findings:';
      title.style.fontSize = '0.875rem';
      title.style.fontWeight = '500';
      title.style.marginBottom = '0.5rem';
      boxDiv.appendChild(title);
      
      // 複選框網格
      const gridDiv = document.createElement('div');
      gridDiv.style.display = 'grid';
      gridDiv.style.gridTemplateColumns = 'repeat(2, 1fr)';
      gridDiv.style.gap = '1rem';
      
      // 選項
      const options = [
          {id: 'fissures', name: 'Cerebral Fissures'},
          {id: 'ventricles', name: 'Ventricles'},
          {id: 'sulci', name: 'Cerebral Sulci'},
          {id: 'interhemisphericFissures', name: 'Interhemispheric Fissures'}
      ];
      
      options.forEach(option => {
          const label = document.createElement('label');
          label.style.display = 'flex';
          label.style.alignItems = 'center';
          label.style.gap = '0.5rem';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = option.id;
          checkbox.name = option.id;
          
          checkbox.addEventListener('change', (e) => {
              window.atrophyFindings[option.id] = e.target.checked;
          });
          
          const span = document.createElement('span');
          span.textContent = option.name;
          span.style.fontSize = '0.875rem';
          
          label.appendChild(checkbox);
          label.appendChild(span);
          gridDiv.appendChild(label);
      });
      
      boxDiv.appendChild(gridDiv);
      container.appendChild(boxDiv);
  }
  
  // React 組件: 小腦交叉失活選項
  function renderCerebellarDiaschisisCheckbox() {
      const container = document.getElementById('atrophy-checkboxes');
      
      window.cerebellarDiaschisis = false;
      
      const boxDiv = document.createElement('div');
      boxDiv.style.marginTop = '0.5rem';
      boxDiv.style.padding = '1rem';
      boxDiv.style.border = '1px solid #ddd';
      boxDiv.style.borderRadius = '4px';
      boxDiv.style.backgroundColor = '#f5f5f5';
      
      const label = document.createElement('label');
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.gap = '0.5rem';
      label.style.opacity = '0.5';
      label.style.cursor = 'not-allowed';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.disabled = true;
      
      checkbox.addEventListener('change', (e) => {
          window.cerebellarDiaschisis = e.target.checked;
      });
      
      const span = document.createElement('span');
      span.textContent = 'Cerebellar Diaschisis';
      span.style.fontSize = '0.875rem';
      
      // 添加事件監聽
      const updateCheckbox = () => {
          const cerebellarLocations = ['left cerebellar', 'right cerebellar', 'bilateral cerebellar'];
          let hasValidLocation = false;
          
          for (const [location, severity] of locationStatusMap) {
              if (cerebellarLocations.some(cl => location.includes(cl)) && severity && severity !== '') {
                  hasValidLocation = true;
                  break;
              }
          }
          
          checkbox.disabled = !hasValidLocation;
          label.style.opacity = hasValidLocation ? '1' : '0.5';
          label.style.cursor = hasValidLocation ? 'pointer' : 'not-allowed';
          
          if (!hasValidLocation) {
              checkbox.checked = false;
              window.cerebellarDiaschisis = false;
          }
      };
      
      document.addEventListener('locationStatusMapChanged', updateCheckbox);
      
      label.appendChild(checkbox);
      label.appendChild(span);
      boxDiv.appendChild(label);
      container.appendChild(boxDiv);
  }

  function clearTable() {
      // 清空 Handsontable
      hot.loadData([['', '']]);
      
      // 重置位置狀態，但保留位置鍵
      for (const location of locationStatusMap.keys()) {
          locationStatusMap.set(location, '');
      }
      
      // 刷新表格
      syncTableWithMap();
      
      // 額外觸發一次事件，確保 cerebellar diaschisis checkbox 更新
      document.dispatchEvent(new CustomEvent('locationStatusMapChanged'));
      
      showNotification('Table cleared');
  }

  function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
          notification.style.display = 'none';
      }, 2000);
  }

  async function copyReport(type) {
      try {
          // Debug output
          console.log('Starting copy process for type:', type);
          
          // 使用導入的generateReports函數
          const reports = generateReports(
              hot, 
              window.atrophyFindings || {
                  fissures: false,
                  ventricles: false,
                  sulci: false,
                  interhemisphericFissures: false
              }, 
              window.cerebellarDiaschisis, 
              LOCATIONS, 
              BILATERAL_ONLY_AREAS, 
              SIDES
          );
          console.log('Generated reports:', reports);
          
          const text = reports[type];
          console.log('Text to copy:', text);
          
          if (text === undefined || text === null) {
              throw new Error('No text generated');
          }

          // Create and append textarea
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';  // Make it invisible
          textArea.style.opacity = '0';
          document.body.appendChild(textArea);
          
          // Select and copy
          textArea.focus();
          textArea.select();
          
          try {
              // Try modern clipboard API first
              await navigator.clipboard.writeText(text);
              console.log('Copied using Clipboard API');
          } catch (clipError) {
              console.log('Clipboard API failed:', clipError);
              // Fallback to execCommand
              const success = document.execCommand('copy');
              console.log('execCommand result:', success);
              if (!success) {
                  throw new Error('execCommand failed');
              }
          }
          
          // Cleanup
          document.body.removeChild(textArea);
          showNotification('Copied to clipboard');
          
      } catch (err) {
          console.error('Copy failed:', err);
          console.error('Error stack:', err.stack);
          showNotification(`Failed to copy: ${err.message}`);
      }
  }

  // 暴露到全局，讓按鈕可以訪問
  window.copyReport = copyReport;
  window.clearTable = clearTable;
</script>
